// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User management
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String
  role          UserRole @default(CLIENT)
  entityId      String?
  isVerified    Boolean  @default(false)
  verificationToken String?
  resetToken    String?
  resetTokenExpiry DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  entity        Entity?  @relation(fields: [entityId], references: [id])
  clientReservations Reservation[] @relation("ClientReservations")
  supervisorReservations Reservation[] @relation("SupervisorReservations")
  supervisorProjects Project[] @relation("SupervisorProjects")
  clientProjects Project[] @relation("ClientProjects")
  createdPriceOffers PriceOffer[] @relation("CreatedBy")
  createdServiceOrders ServiceOrder[] @relation("CreatedBy")

  @@map("users")
}

model Entity {
  id          String   @id @default(cuid())
  name        String
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]

  @@map("entities")
}

// Field and project management
model Field {
  id              String   @id @default(cuid())
  name            String
  location        String
  totalSurfaceM2  Float
  freeSurfaceM2   Float
  status          FieldStatus @default(ACTIVE)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  projects        Project[]
  reservations    Reservation[]

  @@map("fields")
}

model ActivityType {
  id          String   @id @default(cuid())
  label       String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  projects    Project[]

  @@map("activity_types")
}

model Project {
  id              String        @id @default(cuid())
  title           String
  fieldId         String
  clientId        String
  supervisorId    String
  activityTypeId  String?
  surfaceM2       Float
  startDate       DateTime
  endDate         DateTime?
  status          ProjectStatus @default(A_LANCER)
  progressNotes   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  field           Field         @relation(fields: [fieldId], references: [id])
  client          User          @relation("ClientProjects", fields: [clientId], references: [id])
  supervisor      User          @relation("SupervisorProjects", fields: [supervisorId], references: [id])
  activityType    ActivityType? @relation(fields: [activityTypeId], references: [id])

  @@map("projects")
}

model Reservation {
  id                    String            @id @default(cuid())
  clientId              String
  fieldId               String
  surfaceM2Requested    Float
  startRequested        DateTime
  endRequested          DateTime
  status                ReservationStatus @default(PENDING)
  decisionDate          DateTime?
  supervisorId          String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  client                User              @relation("ClientReservations", fields: [clientId], references: [id])
  field                 Field             @relation(fields: [fieldId], references: [id])
  supervisor            User?             @relation("SupervisorReservations", fields: [supervisorId], references: [id])

  @@map("reservations")
}

// Document management (F.10, F.47, F.84)
model InventoryItem {
  id              String   @id @default(cuid())
  owner           String
  family          String
  subFamily       String?
  designation     String
  stockQty        Float
  unit            String
  condition       ItemCondition @default(OK)
  location        String
  lastChecked     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("inventory_items")
}

model PriceOffer {
  id                String   @id @default(cuid())
  destinataire      String
  demandeur         String
  contact           String?
  address           String
  orderNumber       String?
  itemDesignation   String
  unit              String
  techDescription   String?
  quantity          Float
  dateSent          DateTime @default(now())
  status            OfferStatus @default(PENDING)
  createdById       String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  createdBy         User     @relation("CreatedBy", fields: [createdById], references: [id])

  @@map("price_offers")
}

model ServiceOrder {
  id              String   @id @default(cuid())
  objet           String
  marketNumber    String?
  bcNumber        String?
  startDate       DateTime
  clientRep       String
  supplier        String
  status          OrderStatus @default(IN_PROGRESS)
  dateNotified    DateTime @default(now())
  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  createdBy       User     @relation("CreatedBy", fields: [createdById], references: [id])

  @@map("service_orders")
}

// Enums
enum UserRole {
  ADMIN
  SUPERVISOR
  CLIENT
}

enum FieldStatus {
  ACTIVE
  INACTIVE
}

enum ProjectStatus {
  EN_COURS
  FINALISE
  PROGRAMME
  A_LANCER
}

enum ReservationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ItemCondition {
  OK
  NON_CONFORME
  MAUVAIS
}

enum OfferStatus {
  PENDING
  SENT
  ACCEPTED
  REJECTED
}

enum OrderStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
} 